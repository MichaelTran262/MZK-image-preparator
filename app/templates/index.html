{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block body %}
    <script src="{{ url_for('static', filename='js/script.js') }}"></script>
    <input type="text" id="myInput" placeholder="Hledat složku...">
    <div class="row">
        <div class="col">
            <i class="fa fa-arrow-left"></i><a href="{{ prev_page }}">Zpět</a><br>
            <i class="fa fa-home"></i><a href="/">Zpět na kořenovou složku</a>
        </div>
        <div class="col">
          <p style="display:inline">Počet aktivních procesů: <b id="proc_count"></b></p>
        </div>
      </div>
    <table class="table" id="dirTable">
        <thead>
            <tr>
                <th>Složka</th>
                <th class="actions">Akce</th>
            </tr>
        </thead>
        <tbody id="tableContent">
            
        </tbody>
    </table>
    <div id="transferModal" class="modal" tabindex="-1" role="dialog">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <form id="transferForm" action="" method="post" onsubmit="return confirm('Opravdu chcete poslat tuto složku?');">
                <div class="modal-body">
                    <div class="form-group">
                        <label for="path">Cesta</label>
                        <input type="text" id="pathForm" name="path" class="form-control" readonly>
                    </div>
                </div>
                <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Zavřít</button>
                        <button id="transferNowButton" type="submit" form="transferForm" class="btn btn-primary">Poslat do MZK IHNED</button>
                        <button id="transferLaterButton" type="submit" form="transferForm" class="btn btn-danger">Poslat do MZK o půlnoci</button>
                </div>
            </form>
          </div>
        </div>
    </div>
    <script> 
        function fill_table(tbody){
            let myjson = {{ files|tojson|safe }};
            console.log(myjson)
            tbody.empty();
            for(let i = 0; i < myjson.length; i++){
                pathname = window.location.pathname + '/' + myjson[i].dirname
                pathname = pathname.replace(/([^:]\/)\/+/g, "$1");
                console.log(pathname)
                let row = "";
                row += '<tr>';
                row += '<td><i class="fa fa-folder-open"></i><a href="' + pathname + '">' + myjson[i].dirname+ '</a></td>';
                row += '<td class="actions"><form action="/prepare/' + myjson[i].dirpath + '" method="post"> \
                                                <input type="submit" class="btn btn-primary" value="Připravit složky 3 a 4"></form></td>';
                row += '<td class="actions"><button type="button" class="btn btn-primary modal-button" data-toggle="modal" \
                    data-target="#transferModal" data-path="'+ myjson[i].dirpath +'" data-action1="/send_to_mzk_now" data-action2="/send_to_mzk_later">Poslat do MZK</button></td>';
                row += '</tr>';
                tbody.append(row);
            }
            row = '<tr><td>Počet obrázků ve složce: ' + {{ file_count }} + '</td></tr>';
            tbody.append(row);
        }
        $(document).ready(function() {
            let tbody = $('#tableContent');
            fill_table(tbody)
            $('#transferModal').on('show.bs.modal', function(event) {
                var button = $(event.relatedTarget);
                var path = button.data('path');
                var modal = $(this);
                modal.find('#path').val(path);
                modal.find('#myForm').attr('action', '/' + '');
            });
            $('#dirTable').on('click', '.modal-button', function() {
                path = window.location.pathname + '/' + $(this).closest('tr').find('a').text();
                path = path.replace(/([^:]\/)\/+/g, "$1");
                var action1 = $(this).data('action1') + path;
                var action2 = $(this).data('action2') + path;
                $('#transferForm').attr('action', action1); // Set the default action to action1
                $('#pathForm').val(path);
                console.log(path, action1, action2)
                $('#transferNowButton').on('click', function() {
                    $('#transferForm').attr('action', action1);
                });

                $('#transferLaterButton').on('click', function() {
                    $('#transferForm').attr('action', action2);
                });
            });
        });
        
    </script>
{% block modal %}{% endblock %}
{% endblock %}